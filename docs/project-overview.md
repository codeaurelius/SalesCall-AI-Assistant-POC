# Project Overview: CloseAssist (Proof of Concept)

## 1. Project Goal

CloseAssist is a Chrome extension **Proof of Concept (POC)** designed to aid sales professionals during live calls conducted within the browser. It provides real-time audio transcription and automatically extracts key sales-related insights (like pain points, objections, and action items) from the conversation.

**Note:** This is a POC and not intended for production use or distribution.

## 2. Project Structure

The project follows a structure typical for a modern React/TypeScript Chrome Manifest V3 extension:

-   `/`: Root directory.
    -   `manifest.json`: Defines the extension's properties, permissions, content scripts, service worker, and side panel.
    -   `README.md`: General information, setup, usage warnings.
    -   `package.json`: Defines dependencies (React, TypeScript, etc.) and build scripts (`npm run build`, `npm run dev`).
    -   `tsconfig.json`: TypeScript configuration.
    -   `vite.config.ts` / `webpack.config.js` (or similar): Build tool configuration.
    -   `.gitignore`: Specifies intentionally untracked files.
-   `public/`: Static assets.
    -   `icons/`: Extension icons (`icon16.png`, `icon48.png`, etc.).
    -   `index.html`: Base HTML file for the side panel React app.
-   `src/`: Source code directory.
    -   `background/`: Code related to the extension's service worker.
        -   `index.ts`: Main service worker script handling recording state, API calls, messaging.
        -   `state.ts`: Defines and manages the persistent recording state.
        -   `recording.ts`: Logic for managing the recording lifecycle via the offscreen document.
        -   `deepgram.ts`: Logic specific to Deepgram connection/interaction (if separated).
        -   `gemini.ts`: Logic for interacting with the Google Gemini API.
    -   `sidepanel/`: React application for the side panel UI.
        -   `main.tsx`: Entry point for the React app.
        -   `App.tsx`: Root component managing views, state, and interactions.
        -   `index.css`: Styling for the side panel.
        -   `components/`: Reusable React UI components (e.g., `LiveRecording`, `Recordings`, `RecapView`, `Settings`, `TranscriptionView`, `InsightsPanel`).
        -   `hooks/`: Custom React hooks (e.g., `useTranscription`, `useAutomaticAnalysis`, `useExtensionMessaging`).
    -   `offscreen/`: Code for the offscreen document.
        -   `offscreen.html`: Minimal HTML structure.
        -   `offscreen.js`: Handles audio capture (`getUserMedia`), MediaRecorder, and potentially the Deepgram WebSocket connection.
    -   `types/` (or similar): Shared TypeScript type definitions.
    -   `utils/` (or similar): Utility functions.
-   `dist/`: Build output directory (generated by `npm run build`), containing the compiled and bundled extension ready for loading.

## 3. Technologies Used

-   **Frontend Framework:** React, TypeScript
-   **Styling:** CSS (or CSS Modules/Styled Components if used)
-   **Build Tool:** Vite / Webpack (or similar bundler)
-   **Chrome Extension APIs (Manifest V3):**
    -   `chrome.runtime` (Messaging, lifecycle)
    -   `chrome.action` (Toolbar icon)
    -   `chrome.sidePanel` (Primary UI host)
    -   `chrome.offscreen` (Audio capture, WebSocket)
    -   `chrome.storage` (`local`) (API keys, settings, session metadata)
    -   `chrome.permissions` (Requesting `audioCapture`, `tabCapture`, `offscreen`)
    -   `chrome.scripting` (If needed for content script interaction)
-   **Web APIs:**
    -   `navigator.mediaDevices.getUserMedia` (Accessing tab audio, microphone)
    -   `MediaRecorder` (Recording audio streams)
    -   `AudioContext` (Potentially for mixing audio)
    -   `WebSocket` (Real-time communication with Deepgram)
    -   `fetch` (Communicating with Google Gemini API)
    -   `Blob`, `URL.createObjectURL` (Handling audio data temporarily)
-   **Third-Party Services & APIs:**
    -   **Deepgram:** Real-time Speech-to-Text API (via WebSocket).
    -   **Google Gemini:** Generative AI API (via REST/fetch) for insight extraction.

## 4. Core Features (POC)

-   **Audio Capture:** Captures audio from the current browser tab and optionally the user's microphone.
-   **Real-time Transcription:** Streams captured audio to Deepgram for live transcription with speaker diarization.
-   **Real-time Insight Extraction:** Periodically sends recent transcript segments to Google Gemini to identify sales-specific insights (pain points, objections, action items, keywords).
-   **Side Panel UI:**
    -   Displays live transcription feed.
    -   Displays extracted insights in a separate panel.
    -   Provides controls for starting/stopping recording and managing audio sources.
    -   Shows recording status and timer.
    -   Includes settings for API keys and language selection.
    -   Offers a view for preparing call details (topic, participants).
    -   Provides a history view (`Recordings`) to access past sessions.
    -   Includes a recap view (`RecapView`) for reviewing individual session transcripts and insights.
-   **Session Persistence:** Stores session metadata (transcript, insights, duration, setup data - **NO AUDIO**) locally using `chrome.storage.local`.
-   **Data Download:** Allows downloading transcript and insights for individual sessions or all sessions as JSON.
-   **API Key Management:** Securely stores user-provided Deepgram and Gemini keys in local storage.

## 5. Architecture

The extension uses a component-based architecture leveraging React for the UI and standard Manifest V3 patterns:

1.  **Side Panel (React App):** (`src/sidepanel/`) The primary user interface, built with React and TypeScript. Manages its own state using React hooks (`useState`, `useEffect`, custom hooks). Communicates with the background script via `chrome.runtime.sendMessage` for actions and receives updates.
2.  **Background Service Worker:** (`src/background/`) Acts as the central coordinator. Manages overall application state (recording status, API keys), handles communication between the side panel and offscreen document, triggers Gemini analysis, and interacts with `chrome.storage`.
3.  **Offscreen Document:** (`src/offscreen/`) A hidden page used specifically for tasks requiring DOM/Window access:
    *   Accessing `navigator.mediaDevices.getUserMedia` for audio capture.
    *   Running the `MediaRecorder` instance.
    *   Potentially managing the persistent WebSocket connection to Deepgram.
4.  **State Management:** Primarily handled within React components (`useState`, `useReducer`, custom hooks) for UI state, and `chrome.storage.local` orchestrated by the background script for persistent settings and session data.

## 6. Key APIs & Data Flow

1.  **Setup:** User enters Deepgram/Gemini API keys in Side Panel Settings, saved via Background Script to `chrome.storage.local`.
2.  **Start Recording:**
    *   User configures call setup (optional) and clicks "Start Recording" in Side Panel.
    *   Side Panel sends `startRecording` message to Background Script.
    *   Background Script ensures Offscreen Document is running, forwards `startRecording` command.
    *   Offscreen Document uses `getUserMedia`, starts `MediaRecorder`, connects to Deepgram WebSocket.
    *   Status updates (`connecting`, `connected`) are relayed back to Side Panel via Background.
3.  **Live Transcription:**
    *   Offscreen Document sends audio chunks via WebSocket to Deepgram.
    *   Receives transcription results (JSON).
    *   Sends `transcriptionUpdate` message to Background Script.
    *   Background Script forwards transcript segments to Side Panel for display.
4.  **Live Insight Analysis:**
    *   Background Script collects recent final transcript segments.
    *   Periodically (based on triggers like speaker turns or time), sends relevant transcript portions and context (call setup data) to the Google Gemini API via `fetch`.
    *   Receives insight results (JSON) from Gemini.
    *   Sends `insightsUpdate` message to Side Panel.
    *   Side Panel displays insights in the `InsightsPanel`.
5.  **Stop Recording:**
    *   User clicks "Stop Recording".
    *   Command relayed: Side Panel -> Background -> Offscreen.
    *   Offscreen stops `MediaRecorder`, closes Deepgram WebSocket.
    *   **No audio Blob/URL is created for storage.**
    *   Background Script updates state (`isRecording: false`), stores the final transcript, insights, duration, and setup data (without audio URL) to `chrome.storage.local`.
    *   Background Script sends `recordingStopped` message to Side Panel.
6.  **Recap View:**
    *   User selects a past session from the Recordings list in Side Panel.
    *   Side Panel navigates to `RecapView`, loading the selected session data (transcript, insights) from `chrome.storage.local` (via Background script or direct query if architected that way).
7.  **Download:**
    *   User clicks download button (in Recap or Recordings view).
    *   Relevant component retrieves session data(s), formats into JSON (excluding `isFinal` from transcript), creates a Blob, generates a download link, and triggers the download.

## 7. Third-party Integrations

-   **Deepgram:** For real-time transcription. Requires API key.
-   **Google Gemini:** For extracting insights from transcripts. Requires API key.

## 8. Deployment / Setup

-   Requires Node.js and npm/yarn for dependency management and building.
-   **Build:** Run `npm run build` (or equivalent) to compile TS/React and bundle the extension into the `/dist` folder.
-   **Loading:** Load the `/dist` folder as an unpacked extension in `chrome://extensions` (Developer Mode enabled).

## 9. Future Improvements / Considerations (for a non-POC version)

-   More sophisticated error handling and user feedback.
-   User configuration for insight types or analysis prompts.
-   Post-call summary generation.
-   Advanced transcript editing/search.
-   Alternative STT/LLM provider integrations.
-   Robust testing suite (unit, integration, e2e).
-   Scalable storage solution if session history grows large (beyond `chrome.storage.local` limits).
-   UI/UX refinements and accessibility improvements.
-   Stricter security review for API key handling.
